---
layout: article
title: C++中的字节对齐
tags: 
    - 八股文
    - C++
---
关键词：
- 字节对齐、#pragma pack
<!--more-->

## 字节对齐
规则：
1. 看变量所在偏移地址是否为变量大小的整数倍
2. 看对齐后的总大小是否为最长变量的整数倍

| 类型   | 对齐方式（变量存放的起始地址相对于结构的起始地址的偏移量） |
| ------ | ---------------------------------------------------------- |
| char   | 偏移量必须为sizeof(char)即1的倍数                          |
| int    | 偏移量必须为sizeof(int)即4的倍数                           |
| float  | 偏移量必须为sizeof(float)即4的倍数                         |
| double | 偏移量必须为sizeof(double)即8的倍数                        |
| Short  | 偏移量必须为sizeof(short)即2的倍数                         |
```cpp
struct MyStruct { 
    double db; 
    char ch; 
    int i; 
};
```
占用16字节：
1. ```double db```偏移量为0，为8的整数倍
2. ```char ch```偏移量为8，为1的整数倍
3. ```int i```偏移量为9，不为4的整数倍，填充3个无用字节，偏移量变为为12，为4的整数倍
- 占用内存：```8+1+3+4=16```

```cpp
struct MyStruct { 
    char ch; 
    double db; 
    int i; 
};
```
占用24字节：
1. ```char ch```偏移量为0，为1的整数倍
2. ```double db```偏移量为1，不为8的整数倍，填充7个字节，偏移量变为8，为8的整数倍
3. ```int i```偏移量为16，为4的整数倍
- ```1+7+8+4=20```，不为结构中占用最大空间的类型所占用的字节数（double：8）的倍数，填充4个字节，占用内存```1+7+8+4+4=24```

**改变默认字节对齐**
使用```#pragma pack(n)```，规则如下：
1. 如果n大于等于该变量所占用的字节数，那么偏移量必须满足默认的对齐方式；
2. 如果n小于该变量的类型所占用的字节数，那么偏移量为n的倍数，不用满足默认的对齐方式；
3. 结构的总大小的约束条件：
   1. 如果n大于所有成员变量类型所占用的字节数，那么结构的总大小必须为占用空间最大的变量占用的空间数的倍数；
   2. 否则必须为n的倍数
（即n与最大类型占用的字节两者相比，取较小值的倍数。）
```cpp
#pragma pack(push)  //保存对齐状态 
#pragma pack(4)     //设定为4字节对齐 
struct test { 
    char ch; 
    double db; 
    int i; 
}; 
#pragma pack(pop)   //恢复对齐状态 
```
占用16字节：
1. ```char ch```偏移量为0，为1的倍数
2. ```double db```偏移量为1，不为```sizeof(double)=8和n=4中的较小值```的倍数，填充3字节，偏移量为4
3. ```int i```偏移量为12，为4的倍数
- 占用字节```1+3+8+4=16```，为```n=4```的倍数